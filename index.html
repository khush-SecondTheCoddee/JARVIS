<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JARVIS MK-99</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f2ff">
    <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlAUhaSQQ-WtJXZKNtbCVavILA0uMI5hvEvuwiBs30Z2wUJPJdIcPTKXg&s">

    <!-- EXTERNAL CORES -->
    <script src="https://unpkg.com/compromise"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Vision Cores (Lazy Loaded in logic to speed up initial render) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- UI Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- HIGH PERFORMANCE CSS --- */
        :root { --primary: #00f2ff; --warn: #ffcc00; --danger: #ff2a2a; --bg: #000; --glass: rgba(0, 10, 20, 0.6); }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; overflow: hidden; background: var(--bg); color: var(--primary); 
            font-family: 'Rajdhani', sans-serif; height: 100vh; width: 100vw; 
            display: flex; flex-direction: column; 
        }

        /* CAMERA LAYER */
        #cam-feed { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; z-index: 0; filter: brightness(0.8) contrast(1.1); 
        }
        #ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }

        /* HUD LAYER */
        #hud { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; 
            padding: 15px; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        /* TOP BAR */
        .top-deck { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .widget { 
            background: var(--glass); border: 1px solid var(--primary); padding: 5px 10px; 
            font-family: 'Share Tech Mono'; font-size: 11px; margin-bottom: 5px; 
            backdrop-filter: blur(4px); clip-path: polygon(5px 0, 100% 0, 100% 100%, 0 100%, 0 5px);
        }
        .widget i { width: 15px; text-align: center; margin-right: 5px; }

        /* CENTER REACTOR */
        .center-stage { 
            flex-grow: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; position: relative; 
        }
        
        #arc-reactor { 
            width: 120px; height: 120px; border-radius: 50%; border: 2px solid rgba(0,242,255,0.3);
            display: flex; justify-content: center; align-items: center; transition: 0.3s;
            background: radial-gradient(circle, rgba(0,242,255,0.1), transparent 70%);
        }
        .core-ring { 
            position: absolute; width: 100%; height: 100%; border-radius: 50%; 
            border: 2px dashed var(--primary); animation: spin 10s linear infinite; 
        }
        .core-inner { 
            width: 40px; height: 40px; background: #fff; border-radius: 50%; 
            box-shadow: 0 0 30px var(--primary); animation: breath 3s infinite; 
        }

        /* DATA FEED */
        #data-feed {
            position: absolute; right: 10px; top: 20%; width: 200px; max-height: 40%;
            overflow-y: auto; text-align: right; pointer-events: none;
        }
        .feed-item { 
            font-family: 'Share Tech Mono'; font-size: 10px; margin-bottom: 5px; 
            text-shadow: 0 0 2px var(--primary); opacity: 0; animation: slideIn 0.5s forwards; 
        }
        .feed-item img { max-width: 100px; border: 1px solid var(--primary); margin-top: 5px; }

        /* BOTTOM DECK */
        .bottom-deck { 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            padding: 20px; text-align: center; pointer-events: auto; 
        }
        
        #transcript { 
            font-family: 'Share Tech Mono'; color: #fff; font-size: 14px; min-height: 20px; 
            margin-bottom: 15px; text-shadow: 0 0 5px var(--primary); 
        }

        /* TOUCH CONTROLS */
        .control-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .cyber-btn {
            background: rgba(0, 30, 40, 0.6); border: 1px solid var(--primary); color: var(--primary);
            width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; 
            align-items: center; font-size: 18px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 10px rgba(0,242,255,0.1);
        }
        .cyber-btn:active { background: var(--primary); color: #000; transform: scale(0.95); }
        .cyber-btn.active { border-color: var(--warn); color: var(--warn); box-shadow: 0 0 15px var(--warn); }

        /* ANIMATIONS */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes breath { 0%, 100% { opacity: 0.8; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .speaking .core-inner { animation: pulse-speak 0.2s infinite; }
        @keyframes pulse-speak { 0% { transform: scale(1); } 50% { transform: scale(1.3); } }
    </style>
</head>
<body>

    <!-- LAYER 0: CAMERA -->
    <video id="cam-feed" autoplay muted playsinline></video>
    <canvas id="ar-canvas"></canvas>

    <!-- LAYER 1: HUD -->
    <div id="hud">
        <!-- Top Info -->
        <div class="top-deck">
            <div>
                <div class="widget"><i class="fas fa-microchip"></i> MK-99 OMEGA</div>
                <div class="widget" id="clock">00:00:00</div>
                <div class="widget" id="battery-stat"><i class="fas fa-battery-full"></i> --%</div>
            </div>
            <div>
                <div class="widget" id="net-stat"><i class="fas fa-wifi"></i> ONLINE</div>
                <div class="widget" id="loc-stat"><i class="fas fa-location-arrow"></i> GPS: OFF</div>
            </div>
        </div>

        <!-- Dynamic Data Feed (Images, Weather, etc appear here) -->
        <div id="data-feed" id="feed-container"></div>

        <!-- Center Visual -->
        <div class="center-stage">
            <div id="arc-reactor">
                <div class="core-ring"></div>
                <div class="core-inner"></div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="bottom-deck">
            <div id="transcript">>> SYSTEM INITIALIZED. TOUCH TO START.</div>
            <div class="control-grid">
                <button class="cyber-btn" onclick="Jarvis.init()" title="Start Voice"><i class="fas fa-microphone"></i></button>
                <button class="cyber-btn" onclick="Vision.toggle()" title="Toggle AR Hands"><i class="fas fa-hand-sparkles"></i></button>
                <button class="cyber-btn" onclick="Cam.switch()" title="Flip Camera"><i class="fas fa-camera-rotate"></i></button>
                <button class="cyber-btn" onclick="Hardware.torch()" title="Flashlight"><i class="fas fa-lightbulb"></i></button>
                <button class="cyber-btn" onclick="Jarvis.stop()" title="Stop"><i class="fas fa-stop"></i></button>
            </div>
        </div>
    </div>

    <!-- LOGIC CORE -->
    <script>
        // --- UTILS ---
        const $ = (id) => document.getElementById(id);
        const log = (msg, img=null) => {
            const div = document.createElement('div');
            div.className = 'feed-item';
            div.innerHTML = `> ${msg}`;
            if(img) div.innerHTML += `<br><img src="${img}">`;
            $('data-feed').prepend(div);
            // Cleanup old logs
            if($('data-feed').children.length > 5) $('data-feed').lastChild.remove();
        };

        // --- 1. HARDWARE LAYER (Mobile Native Features) ---
        const Hardware = {
            init: () => {
                // Clock
                setInterval(() => $('clock').innerText = new Date().toLocaleTimeString(), 1000);
                // Battery
                if(navigator.getBattery) navigator.getBattery().then(b => {
                    const update = () => $('battery-stat').innerHTML = `<i class="fas fa-battery-half"></i> ${(b.level*100).toFixed(0)}%`;
                    update(); b.addEventListener('levelchange', update);
                });
                // Network
                window.addEventListener('offline', () => $('net-stat').innerHTML = '<i class="fas fa-ban"></i> OFFLINE');
                window.addEventListener('online', () => $('net-stat').innerHTML = '<i class="fas fa-wifi"></i> ONLINE');
            },
            torch: async () => {
                try {
                    const track = Cam.stream.getVideoTracks()[0];
                    const caps = track.getCapabilities();
                    if(caps.torch) {
                        const current = track.getSettings().torch;
                        await track.applyConstraints({ advanced: [{ torch: !current }] });
                        log("FLASHLIGHT TOGGLED");
                    } else log("TORCH NOT AVAILABLE");
                } catch(e) { log("HARDWARE ERROR: " + e.message); }
            },
            vibrate: (pattern) => {
                if(navigator.vibrate) navigator.vibrate(pattern);
            }
        };

        // --- 2. CAMERA LAYER (Optimized) ---
        const Cam = {
            video: $('cam-feed'),
            stream: null,
            facing: 'environment',
            
            init: async () => {
                try {
                    Cam.stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: Cam.facing, width: {ideal: 1280}, height: {ideal: 720} },
                        audio: false
                    });
                    Cam.video.srcObject = Cam.stream;
                } catch(e) { 
                    log("CAMERA ACCESS DENIED"); 
                    alert("Allow Camera for AR features"); 
                }
            },
            switch: () => {
                if(Cam.stream) Cam.stream.getTracks().forEach(t => t.stop());
                Cam.facing = Cam.facing === 'user' ? 'environment' : 'user';
                Cam.init();
            }
        };

        // --- 3. VISION LAYER (MediaPipe Hands) ---
        const Vision = {
            active: false,
            hands: null,
            camera: null,
            
            toggle: async () => {
                Vision.active = !Vision.active;
                if(Vision.active) {
                    log("INITIALIZING NEURAL NET...");
                    if(!Vision.hands) await Vision.load();
                    Vision.camera.start();
                    log("HAND TRACKING ACTIVE");
                } else {
                    if(Vision.camera) Vision.camera.stop();
                    // Clear canvas
                    const ctx = $('ar-canvas').getContext('2d');
                    ctx.clearRect(0,0, $('ar-canvas').width, $('ar-canvas').height);
                    log("VISION SENSORS STANDBY");
                }
            },

            load: async () => {
                Vision.hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                Vision.hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5});
                Vision.hands.onResults(Vision.draw);
                
                Vision.camera = new Camera(Cam.video, {
                    onFrame: async () => { await Vision.hands.send({image: Cam.video}); },
                    width: 1280, height: 720
                });
            },

            draw: (results) => {
                const canvas = $('ar-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00f2ff', lineWidth: 2});
                        drawLandmarks(ctx, landmarks, {color: '#ffffff', lineWidth: 1});
                        
                        // PALM RECOGNITION (Simple Pinch)
                        const d = Math.hypot(landmarks[8].x - landmarks[4].x, landmarks[8].y - landmarks[4].y);
                        if(d < 0.05) {
                            ctx.beginPath();
                            ctx.arc(landmarks[8].x * canvas.width, landmarks[8].y * canvas.height, 20, 0, 2*Math.PI);
                            ctx.fillStyle = "rgba(255, 200, 0, 0.5)";
                            ctx.fill();
                        }
                    }
                }
            }
        };

        // --- 4. BRAIN (Skill Registry & APIs) ---
        const Skills = {
            // A. KNOWLEDGE
            'weather': async () => {
                try {
                    const res = await axios.get('https://api.open-meteo.com/v1/forecast?latitude=40.71&longitude=-74.01&current_weather=true');
                    return `Current temperature is ${res.data.current_weather.temperature} degrees.`;
                } catch(e) { return "Unable to access meteorological satellites."; }
            },
            'crypto': async () => {
                try {
                    const res = await axios.get('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd');
                    return `Bitcoin: $${res.data.bitcoin.usd}. Ethereum: $${res.data.ethereum.usd}.`;
                } catch(e) { return "Market data offline."; }
            },
            'joke': async () => {
                const res = await axios.get('https://v2.jokeapi.dev/joke/Any?type=single&safe-mode');
                return res.data.joke;
            },
            'space': async () => {
                const res = await axios.get('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY');
                log("NASA APOD", res.data.url);
                return `NASA Photo: ${res.data.title}`;
            },
            'fact': async () => {
                const res = await axios.get('https://uselessfacts.jsph.pl/random.json?language=en');
                return res.data.text;
            },
            'news': async () => {
                return "Connecting to global news feeds... (Simulated)";
            },
            
            // B. TOOLS
            'open google': () => { window.open('https://google.com'); return "Opening Google."; },
            'open youtube': () => { window.open('https://youtube.com'); return "Launching YouTube."; },
            'flashlight': () => { Hardware.torch(); return "Torch toggled."; },
            'camera': () => { Cam.switch(); return "Switching optical sensors."; },
            'scan': () => { Vision.toggle(); return "Toggling vision matrix."; },
            
            // C. FALLBACK (Wiki)
            'search': async (query) => {
                const res = await axios.get(`https://en.wikipedia.org/api/rest_v1/page/summary/${query}`);
                if(res.data.thumbnail) log("WIKI IMAGE", res.data.thumbnail.source);
                return res.data.extract.split('.')[0];
            }
        };

        // --- 5. CORE CONTROLLER ---
        const Jarvis = {
            recognition: null,
            synth: window.speechSynthesis,
            
            init: () => {
                Cam.init();
                Hardware.init();
                
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!Speech) return alert("Use Chrome/Edge/Safari");
                
                Jarvis.recognition = new Speech();
                Jarvis.recognition.lang = 'en-US';
                Jarvis.recognition.continuous = true;
                
                Jarvis.recognition.onstart = () => {
                    $('transcript').innerText = ">> LISTENING...";
                    $('arc-reactor').style.borderColor = "#00ff00";
                    Hardware.vibrate(50);
                };
                
                Jarvis.recognition.onresult = async (e) => {
                    const text = e.results[e.results.length-1][0].transcript.toLowerCase();
                    $('transcript').innerText = `>> ${text.toUpperCase()}`;
                    await Jarvis.process(text);
                };
                
                Jarvis.recognition.start();
                Jarvis.speak("Online.");
            },
            
            stop: () => {
                if(Jarvis.recognition) Jarvis.recognition.stop();
                $('transcript').innerText = ">> STANDBY";
                $('arc-reactor').style.borderColor = "var(--primary)";
            },

            process: async (text) => {
                // Parse Intent (Simple NLP)
                let response = "";
                
                if(text.includes('weather')) response = await Skills.weather();
                else if(text.includes('bitcoin') || text.includes('price')) response = await Skills.crypto();
                else if(text.includes('joke')) response = await Skills.joke();
                else if(text.includes('space') || text.includes('nasa')) response = await Skills.space();
                else if(text.includes('fact')) response = await Skills.fact();
                else if(text.includes('torch') || text.includes('light')) response = Skills.flashlight();
                else if(text.includes('hand') || text.includes('vision')) response = Skills.scan();
                else if(text.includes('camera')) response = Skills.camera();
                else if(text.includes('hello')) response = "Systems functional. Ready for input.";
                
                // Smart Fallback
                else {
                    const doc = nlp(text); // Compromise.js
                    const nouns = doc.nouns().out('array');
                    if(nouns.length > 0) {
                        const query = nouns[nouns.length-1]; // Get last noun
                        response = await Skills.search(query);
                    } else {
                        response = "Command not recognized within protocol.";
                    }
                }
                
                Jarvis.speak(response);
            },

            speak: (text) => {
                if(!text) return;
                const utter = new SpeechSynthesisUtterance(text);
                utter.rate = 1.1; utter.pitch = 0.9;
                
                // Animation triggers
                utter.onstart = () => {
                    document.body.classList.add('speaking');
                    // Add to feed
                    log(text);
                };
                utter.onend = () => document.body.classList.remove('speaking');
                
                Jarvis.synth.speak(utter);
            }
        };

        // Init SW
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
