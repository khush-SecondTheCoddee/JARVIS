<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J.A.R.V.I.S | MK-85 Omni-System</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f2ff">
    <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlAUhaSQQ-WtJXZKNtbCVavILA0uMI5hvEvuwiBs30Z2wUJPJdIcPTKXg&s">

    <!-- EXTERNAL LIBRARIES -->
    <!-- Vision & AR -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- Intelligence & Utils -->
    <script src="https://unpkg.com/compromise"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <!-- Mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #00f2ff; --secondary: #008cff; --alert: #ff2a2a; --bg: #000; --glass: rgba(0, 15, 20, 0.85); }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Orbitron', sans-serif; color: var(--primary); user-select: none; }

        /* --- LAYERS --- */
        #video-feed { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; z-index: 0; display:none; }
        #ar-scene { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; pointer-events: none; }
        #canvas-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 2; pointer-events: none; }
        
        /* --- HUD --- */
        #hud { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; pointer-events: none; display: grid; grid-template-rows: 60px 1fr 100px; padding: 10px; box-sizing: border-box; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .stat-badge { background: var(--glass); border: 1px solid var(--primary); padding: 5px 15px; font-family: 'Share Tech Mono'; font-size: 12px; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); display: flex; align-items: center; gap: 10px; }
        .blink { animation: blink 1s infinite; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; }

        /* Main Content */
        main { position: relative; display: flex; justify-content: center; align-items: center; }
        
        /* Map Overlay (Hidden by default) */
        #map-overlay { position: absolute; width: 80%; height: 60%; background: rgba(0,0,0,0.9); border: 2px solid var(--primary); z-index: 20; display: none; pointer-events: auto; border-radius: 10px; }
        #map-container { width: 100%; height: 100%; }

        /* Arc Reactor */
        #reactor { width: 150px; height: 150px; border: 2px dashed var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0,242,255,0.2); transition: 0.3s; }
        .core { width: 40%; height: 40%; background: var(--primary); border-radius: 50%; box-shadow: 0 0 50px var(--primary); opacity: 0.8; animation: pulse 3s infinite; }
        .speaking #reactor { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 60px var(--primary); }
        .speaking .core { animation: pulse-fast 0.2s infinite; }

        /* Footer */
        footer { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 10px; pointer-events: auto; }
        #transcript { background: var(--glass); padding: 10px 20px; border-left: 3px solid var(--primary); font-family: 'Share Tech Mono'; width: 90%; text-align: center; font-size: 14px; min-height: 20px; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; overflow-x: auto; max-width: 100%; padding-bottom: 5px; }
        .btn { background: rgba(0,0,0,0.7); border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; font-family: 'Orbitron'; font-size: 12px; cursor: pointer; white-space: nowrap; transition: 0.2s; clip-path: polygon(10px 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); }
        .btn:hover { background: var(--primary); color: #000; }
        .btn i { margin-right: 5px; }

        /* Music Player UI */
        #music-player { position: absolute; right: 20px; bottom: 120px; width: 200px; background: var(--glass); border: 1px solid var(--secondary); padding: 10px; display: none; font-family: 'Share Tech Mono'; pointer-events: auto; }
        #music-status { font-size: 10px; margin-bottom: 5px; color: var(--secondary); }
        .visualizer-bar { height: 2px; width: 100%; background: var(--secondary); margin-top: 5px; animation: eq 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes pulse-fast { 0%, 100% { opacity: 0.8; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes eq { 0%, 100% { width: 30%; } 50% { width: 100%; } }
    </style>
</head>
<body>

    <!-- VIDEO & AR LAYERS -->
    <video id="video-feed" playsinline></video>
    <canvas id="canvas-layer"></canvas>
    
    <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false">
        <a-entity camera look-controls="enabled: false"></a-entity>
        <a-entity id="hologram-anchor" position="0 0 -2"></a-entity>
        <a-light type="ambient" color="#FFF" intensity="0.5"></a-light>
        <a-light type="directional" position="-1 1 1"></a-light>
    </a-scene>

    <!-- HUD LAYER -->
    <div id="hud">
        <header>
            <div class="stat-badge"><span class="blink"></span> SYS.ONLINE</div>
            <div class="stat-badge" id="ble-status"><i class="fab fa-bluetooth-b"></i> DISCONNECTED</div>
            <div class="stat-badge" id="geo-status"><i class="fas fa-globe"></i> GPS READY</div>
        </header>

        <main>
            <div id="reactor">
                <div class="core"></div>
            </div>

            <!-- MAP POPUP -->
            <div id="map-overlay">
                <div id="map-container"></div>
                <button class="btn" onclick="toggleMap(false)" style="position:absolute; top:10px; right:10px; z-index:1000;">CLOSE</button>
            </div>

            <!-- MUSIC UI -->
            <div id="music-player">
                <div id="music-status">BUFFERING STREAM...</div>
                <div style="font-size:12px; color:#fff;" id="station-name">NO SIGNAL</div>
                <div class="visualizer-bar"></div>
                <audio id="audio-stream" crossorigin="anonymous"></audio>
            </div>
        </main>

        <footer>
            <div id="transcript">>> AWAITING PROTOCOL INITIALIZATION</div>
            <div class="controls">
                <button class="btn" onclick="sys.init()"><i class="fas fa-power-off"></i> INIT</button>
                <button class="btn" onclick="ble.connect()"><i class="fab fa-bluetooth"></i> PAIR DEVICE</button>
                <button class="btn" onclick="vision.toggleOCR()"><i class="fas fa-eye"></i> READ TEXT</button>
                <button class="btn" onclick="cam.switch()"><i class="fas fa-camera-rotate"></i> FLIP CAM</button>
            </div>
        </footer>
    </div>

    <script>
        // --- CORE SYSTEMS ---
        const ui = {
            transcript: document.getElementById('transcript'),
            reactor: document.getElementById('reactor'),
            bleStatus: document.getElementById('ble-status'),
            mapOverlay: document.getElementById('map-overlay'),
            holograms: document.getElementById('hologram-anchor'),
            music: {
                box: document.getElementById('music-player'),
                name: document.getElementById('station-name'),
                audio: document.getElementById('audio-stream')
            }
        };

        const sys = {
            active: false,
            init: () => {
                if(sys.active) return;
                sys.active = true;
                cam.start();
                voice.speak("Interface initialized. All sensors online.");
                ui.transcript.innerText = ">> LISTENING...";
                voice.listen();
                
                // Init Map
                map.init();
            }
        };

        // --- 1. CAMERA & HAND TRACKING (PALM CONTROL) ---
        const cam = {
            video: document.getElementById('video-feed'),
            canvas: document.getElementById('canvas-layer'),
            ctx: document.getElementById('canvas-layer').getContext('2d'),
            facingMode: 'environment',
            activeObj: null,

            start: () => {
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                hands.onResults(cam.onHands);

                const camera = new Camera(cam.video, {
                    onFrame: async () => { await hands.send({image: cam.video}); },
                    width: 1280, height: 720, facingMode: cam.facingMode
                });
                camera.start();
            },

            switch: () => {
                cam.facingMode = cam.facingMode === 'user' ? 'environment' : 'user';
                cam.start(); // Restart with new mode
            },

            onHands: (results) => {
                cam.canvas.width = window.innerWidth;
                cam.canvas.height = window.innerHeight;
                cam.ctx.clearRect(0, 0, cam.canvas.width, cam.canvas.height);
                
                // Draw skeleton
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    for (const landmarks of results.multiHandLandmarks) {
                        drawConnectors(cam.ctx, landmarks, HAND_CONNECTIONS, {color: '#00f2ff', lineWidth: 2});
                        drawLandmarks(cam.ctx, landmarks, {color: '#fff', lineWidth: 1});
                        cam.detectGesture(landmarks);
                    }
                }
            },

            detectGesture: (landmarks) => {
                // PINCH DETECTION (Thumb Tip 4 & Index Tip 8)
                const d = Math.hypot(landmarks[8].x - landmarks[4].x, landmarks[8].y - landmarks[4].y);
                
                if (d < 0.05 && cam.activeObj) {
                    // SCALING LOGIC based on Hand Height (Y)
                    const scale = Math.max(0.1, (1 - landmarks[8].y) * 3);
                    cam.activeObj.setAttribute('scale', `${scale} ${scale} ${scale}`);
                    ui.transcript.innerText = `>> GESTURE: SCALING OBJECT ${(scale*100).toFixed(0)}%`;
                }
            }
        };

        // --- 2. VISION (OCR & AR) ---
        const vision = {
            isReading: false,
            
            toggleOCR: () => {
                vision.isReading = !vision.isReading;
                if(vision.isReading) {
                    voice.speak("Visual cortex scanning for text.");
                    ui.transcript.innerText = ">> PROCESSING VIDEO FEED...";
                    vision.scan();
                } else {
                    voice.speak("Scanning terminated.");
                }
            },

            scan: async () => {
                if(!vision.isReading) return;
                // Capture frame from video
                const canvas = document.createElement('canvas');
                canvas.width = cam.video.videoWidth; canvas.height = cam.video.videoHeight;
                canvas.getContext('2d').drawImage(cam.video, 0, 0);
                
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
                if(text.trim().length > 5) {
                    ui.transcript.innerText = `>> READ: ${text.substring(0, 50)}...`;
                    voice.speak(`I see text saying: ${text}`);
                    vision.isReading = false; // Stop after success
                } else {
                    requestAnimationFrame(vision.scan); // Retry
                }
            },

            spawn: (shape, color) => {
                ui.holograms.innerHTML = ''; // Clear
                const el = document.createElement(`a-${shape}`);
                el.setAttribute('material', `color: ${color}; wireframe: true; opacity: 0.8;`);
                el.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 5000');
                ui.holograms.appendChild(el);
                cam.activeObj = el;
            }
        };

        // --- 3. BLUETOOTH (Hardware Control) ---
        const ble = {
            device: null,
            connect: async () => {
                try {
                    voice.speak("Scanning for Bluetooth peripherals.");
                    // Scan for Generic devices (Battery Service is common)
                    ble.device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service']
                    });
                    
                    const server = await ble.device.gatt.connect();
                    ui.bleStatus.innerHTML = `<i class="fab fa-bluetooth"></i> ${ble.device.name || "DEVICE"} PAIRED`;
                    ui.bleStatus.style.borderColor = "#33ff33";
                    voice.speak(`Connected to ${ble.device.name}.`);
                    
                    ble.device.addEventListener('gattserverdisconnected', () => {
                        ui.bleStatus.innerHTML = `<i class="fab fa-bluetooth-b"></i> DISCONNECTED`;
                        voice.speak("Device connection lost.");
                    });
                } catch(e) {
                    voice.speak("Bluetooth pairing cancelled or failed.");
                    console.error(e);
                }
            }
        };

        // --- 4. MUSIC (Radio Browser API) ---
        const audio = {
            playGenre: async (genre) => {
                voice.speak(`Tuning frequencies to ${genre}.`);
                ui.music.box.style.display = 'block';
                ui.music.name.innerText = "SEARCHING SATELLITE...";
                
                try {
                    const res = await axios.get(`https://de1.api.radio-browser.info/json/stations/bytag/${genre}?limit=10`);
                    if(res.data.length > 0) {
                        const station = res.data[Math.floor(Math.random() * res.data.length)];
                        ui.music.name.innerText = station.name;
                        ui.music.audio.src = station.url_resolved;
                        ui.music.audio.play();
                    } else {
                        voice.speak("No signals found on that frequency.");
                    }
                } catch(e) { voice.speak("Audio subsystem error."); }
            },
            stop: () => {
                ui.music.audio.pause();
                ui.music.box.style.display = 'none';
                voice.speak("Audio playback ceased.");
            }
        };

        // --- 5. MAPPING (Leaflet) ---
        const map = {
            instance: null,
            init: () => {
                // Initialize hidden, ready to show
                map.instance = L.map('map-container').setView([0,0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO'
                }).addTo(map.instance);
            },
            locate: () => {
                toggleMap(true);
                voice.speak("Triangulating global position.");
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    map.instance.setView([latitude, longitude], 13);
                    L.marker([latitude, longitude]).addTo(map.instance)
                        .bindPopup("TARGET LOCATION CONFIRMED").openPopup();
                    voice.speak(`Location acquired. Latitude ${latitude.toFixed(2)}, Longitude ${longitude.toFixed(2)}.`);
                });
            }
        };

        function toggleMap(show) {
            ui.mapOverlay.style.display = show ? 'block' : 'none';
            if(show) setTimeout(() => map.instance.invalidateSize(), 100);
        }

        // --- 6. VOICE & INTELLIGENCE ---
        const voice = {
            synth: window.speechSynthesis,
            recognition: new (window.SpeechRecognition || window.webkitSpeechRecognition)(),
            
            listen: () => {
                voice.recognition.lang = 'en-US';
                voice.recognition.continuous = true;
                voice.recognition.onresult = (e) => {
                    const text = e.results[e.results.length-1][0].transcript.toLowerCase();
                    ui.transcript.innerText = `>> ${text.toUpperCase()}`;
                    voice.process(text);
                };
                voice.recognition.start();
            },

            speak: (text) => {
                ui.reactor.parentNode.classList.add('speaking');
                const utter = new SpeechSynthesisUtterance(text);
                // Try to find a cool voice
                const voices = voice.synth.getVoices();
                utter.voice = voices.find(v => v.name.includes("Google UK English Male")) || voices[0];
                utter.pitch = 0.9; utter.rate = 1.1;
                utter.onend = () => ui.reactor.parentNode.classList.remove('speaking');
                voice.synth.speak(utter);
            },

            process: async (cmd) => {
                // NATURAL LANGUAGE PROCESSING (Rule-Based + API)
                
                // MUSIC
                if(cmd.includes('play')) {
                    const genre = cmd.replace('play', '').trim() || 'lofi';
                    audio.playGenre(genre);
                    return;
                }
                if(cmd.includes('stop music')) { audio.stop(); return; }

                // VISION
                if(cmd.includes('read') || cmd.includes('scan text')) { vision.toggleOCR(); return; }
                if(cmd.includes('show') || cmd.includes('spawn')) {
                    const color = ['red','blue','green','yellow'].find(c => cmd.includes(c)) || 'cyan';
                    const shape = cmd.includes('sphere') ? 'sphere' : cmd.includes('box') ? 'box' : 'cylinder';
                    vision.spawn(shape, color);
                    voice.speak(`Constructing ${color} ${shape}.`);
                    return;
                }

                // UTILS
                if(cmd.includes('connect') || cmd.includes('pair')) { ble.connect(); return; }
                if(cmd.includes('where am i') || cmd.includes('location')) { map.locate(); return; }
                
                // DATA
                if(cmd.includes('battery')) {
                    const batt = await navigator.getBattery();
                    voice.speak(`Power levels at ${(batt.level*100).toFixed(0)} percent.`);
                    return;
                }
                
                // CONVERSATION
                if(cmd.includes('hello')) { voice.speak("At your service."); return; }
                if(cmd.includes('shutdown')) { 
                    voice.speak("Powering down systems.");
                    document.body.style.filter = "grayscale(100%)";
                    return; 
                }
            }
        };

        // Initialize voices
        window.speechSynthesis.getVoices();
    </script>
</body>
</html>
