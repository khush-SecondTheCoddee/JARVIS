<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JARVIS MK-X</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00f2ff">

    <!-- CORES -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/compromise"></script>
    <!-- MEDIAPIPE (Lazy loaded by script for speed, but link here for cache) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <!-- STYLES -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #00f2ff; --bg: #000; --glass: rgba(0, 10, 20, 0.8); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: var(--bg); color: var(--primary); font-family: 'Rajdhani', sans-serif; height: 100vh; width: 100vw; }

        /* --- 1. BOOT SCREEN (The Overlay) --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; cursor: pointer;
        }
        .boot-circle {
            width: 80px; height: 80px; border: 4px solid var(--primary); border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .boot-text { font-family: 'Share Tech Mono'; font-size: 14px; letter-spacing: 2px; color: #fff; }
        .tap-hint { margin-top: 20px; font-size: 12px; color: #aaa; animation: flash 1s infinite; }

        /* --- 2. MAIN LAYERS --- */
        #cam-feed { position: fixed; top:0; left:0; width:100%; height:100%; object-fit: cover; z-index: -2; filter: brightness(0.7); }
        #ar-scene { position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1; pointer-events: none; }
        
        /* --- 3. HUD --- */
        #hud { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; padding: 20px; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        .widget { background: var(--glass); border: 1px solid var(--primary); padding: 5px 12px; font-family: 'Share Tech Mono'; font-size: 10px; margin-bottom: 5px; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); }
        
        #console { text-align: center; font-family: 'Share Tech Mono'; font-size: 12px; color: #fff; text-shadow: 0 0 5px var(--primary); margin-bottom: 20px; }
        
        /* Cursor for Hands */
        #hand-cursor { 
            position: absolute; width: 30px; height: 30px; border: 2px solid var(--primary); border-radius: 50%; 
            transform: translate(-50%, -50%); display: none; pointer-events: none; z-index: 20; 
            box-shadow: 0 0 15px var(--primary); transition: width 0.1s, background 0.1s;
        }
        #hand-cursor.locked { background: rgba(0, 242, 255, 0.3); width: 15px; height: 15px; border-color: #fff; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes flash { 50% { opacity: 0.3; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- BOOT SCREEN (Auto Init Layer) -->
    <div id="boot-screen" onclick="sys.boot()">
        <div class="boot-circle"></div>
        <div class="boot-text">J.A.R.V.I.S. MK-X</div>
        <div class="boot-text" style="font-size:10px; margin-top:5px; color:#555;">SYSTEM PRE-CHECK COMPLETE</div>
        <div class="tap-hint">[ TAP ANYWHERE TO INITIALIZE ]</div>
    </div>

    <!-- MAIN UI -->
    <video id="cam-feed" autoplay muted playsinline></video>
    <div id="hand-cursor"></div>

    <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false">
        <a-entity id="rig" position="0 1.6 0"><a-entity camera look-controls="enabled: false"></a-entity></a-entity>
        <a-light type="ambient" color="#FFF" intensity="0.8"></a-light>
        <a-entity id="anchor" position="0 1.6 -3"></a-entity>
    </a-scene>

    <div id="hud">
        <div class="top-bar">
            <div>
                <div class="widget">SYS: ONLINE</div>
                <div class="widget" id="hand-stat">HANDS: OFF</div>
            </div>
            <div class="widget" id="clock">00:00</div>
        </div>
        <div id="console">>> WAITING FOR BOOT SEQUENCE...</div>
    </div>

    <script>
        const ui = {
            boot: document.getElementById('boot-screen'),
            console: document.getElementById('console'),
            video: document.getElementById('cam-feed'),
            cursor: document.getElementById('hand-cursor'),
            anchor: document.getElementById('anchor'),
            handStat: document.getElementById('hand-stat'),
            clock: document.getElementById('clock')
        };

        let activeModel = null;
        let isGrabbed = false;

        // --- 1. SYSTEM BOOTLOADER ---
        const sys = {
            booted: false,
            boot: async () => {
                if(sys.booted) return;
                sys.booted = true;

                // UI Transition
                ui.boot.style.opacity = '0';
                setTimeout(() => ui.boot.classList.add('hidden'), 500);

                // 1. Audio Init
                voice.speak("System initialized.");
                
                // 2. Camera Init
                await cam.init();
                
                // 3. Hands Init (Background)
                hands.init();
                
                // 4. Voice Listen
                voice.listen();
                
                // 5. Utils
                setInterval(() => ui.clock.innerText = new Date().toLocaleTimeString(), 1000);
                ui.console.innerText = ">> COMMANDS LISTENING...";
            }
        };

        // --- 2. CAMERA CORE ---
        const cam = {
            init: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }
                    });
                    ui.video.srcObject = stream;
                } catch(e) {
                    alert("Camera Permission Required!");
                }
            }
        };

        // --- 3. HAND TRACKING CORE ---
        const hands = {
            instance: null,
            camera: null,
            init: () => {
                hands.instance = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.instance.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6});
                hands.instance.onResults(hands.onResult);
                
                hands.camera = new Camera(ui.video, {
                    onFrame: async () => { await hands.instance.send({image: ui.video}); },
                    width: 1280, height: 720
                });
                hands.camera.start();
            },
            onResult: (results) => {
                if(results.multiHandLandmarks.length > 0) {
                    ui.handStat.innerText = "HANDS: LOCKED";
                    ui.handStat.style.borderColor = "#00f2ff";
                    
                    const lm = results.multiHandLandmarks[0];
                    
                    // 2D Cursor Mapping
                    const x = (1 - lm[9].x) * window.innerWidth;
                    const y = lm[9].y * window.innerHeight;
                    ui.cursor.style.display = 'block';
                    ui.cursor.style.left = x + 'px';
                    ui.cursor.style.top = y + 'px';

                    // Pinch Logic (Index 8 & Thumb 4)
                    const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
                    if(d < 0.05) {
                        ui.cursor.classList.add('locked');
                        if(activeModel) {
                            // Map 2D -> 3D movement
                            const mx = (0.5 - lm[9].x) * 5;
                            const my = (0.5 - lm[9].y) * 3;
                            activeModel.setAttribute('position', `${mx} ${my} 0`);
                        }
                    } else {
                        ui.cursor.classList.remove('locked');
                    }
                } else {
                    ui.handStat.innerText = "HANDS: SEARCHING";
                    ui.handStat.style.borderColor = "#555";
                    ui.cursor.style.display = 'none';
                }
            }
        };

        // --- 4. AR SPAWNER ---
        const ar = {
            spawn: (type, color='#00f2ff') => {
                ui.anchor.innerHTML = ''; // Clean slate
                const el = document.createElement('a-entity');
                
                // Complex Models vs Primitives
                if(type === 'drone') {
                    el.setAttribute('gltf-model', 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/CesiumDrone/glTF/CesiumDrone.gltf');
                    el.setAttribute('scale', '0.5 0.5 0.5');
                } else if (type === 'helmet') {
                    el.setAttribute('gltf-model', 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/SciFiHelmet/glTF/SciFiHelmet.gltf');
                    el.setAttribute('scale', '0.3 0.3 0.3');
                } else {
                    // Primitive
                    if(type === 'box') el.setAttribute('geometry', 'primitive: box');
                    else if(type === 'sphere') el.setAttribute('geometry', 'primitive: sphere');
                    else if(type === 'cone') el.setAttribute('geometry', 'primitive: cone');
                    
                    el.setAttribute('material', `color: ${color}; wireframe: true; opacity: 0.8`);
                }

                // Animation
                el.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear');
                ui.anchor.appendChild(el);
                activeModel = el;
                ui.console.innerText = `>> SPAWNED: ${type.toUpperCase()}`;
            },
            clear: () => {
                ui.anchor.innerHTML = '';
                activeModel = null;
            }
        };

        // --- 5. VOICE CORE ---
        const voice = {
            synth: window.speechSynthesis,
            recognition: new (window.SpeechRecognition || window.webkitSpeechRecognition)(),
            
            speak: (text) => {
                const u = new SpeechSynthesisUtterance(text);
                u.rate = 1.1; u.pitch = 0.9;
                voice.synth.speak(u);
            },
            
            listen: () => {
                voice.recognition.lang = 'en-US';
                voice.recognition.continuous = true;
                voice.recognition.onresult = (e) => {
                    const txt = e.results[e.results.length-1][0].transcript.toLowerCase();
                    ui.console.innerText = `>> CMD: ${txt}`;
                    voice.process(txt);
                };
                voice.recognition.onend = () => voice.recognition.start(); // Auto-restart
                voice.recognition.start();
            },

            process: (cmd) => {
                // AR Commands
                if(cmd.includes('drone')) ar.spawn('drone');
                else if(cmd.includes('helmet')) ar.spawn('helmet');
                else if(cmd.includes('box')) ar.spawn('box', 'cyan');
                else if(cmd.includes('sphere')) ar.spawn('sphere', 'red');
                else if(cmd.includes('clear') || cmd.includes('remove')) { ar.clear(); voice.speak("Area cleared."); }
                
                // Color Change
                else if(cmd.includes('red') && activeModel) activeModel.setAttribute('material', 'color: red; wireframe: true');
                else if(cmd.includes('blue') && activeModel) activeModel.setAttribute('material', 'color: blue; wireframe: true');
                
                // System
                else if(cmd.includes('hello')) voice.speak("Online and ready.");
                else if(cmd.includes('time')) voice.speak("It is " + new Date().toLocaleTimeString());
            }
        };

        // Service Worker Reg
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    </script>
</body>
    </html>
